<!-- ฺฉุฏ ฺฉุงูู ุงุตูุงุญโุดุฏู -->
<input type="text" id="code" placeholder="ฺฉุฏ ุจุงุฒุงุฑุงุจ ุฑุง ูุงุฑุฏ ฺฉูุฏ" autocomplete="off" />

<select id="type" aria-label="ููุน ุซุจุช ุญุถูุฑ">
  <option value="" disabled selected>ููุน ุซุจุช ุญุถูุฑ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ</option>
  <option value="ุดุฑูุน ุดูุช">ุดุฑูุน ุดูุช</option>
  <option value="ูพุงุงู ุดูุช">ูพุงุงู ุดูุช</option>
  <option value="ุซุจุช ูุงู ุฌุฏุฏ">ุซุจุช ูุงู ุฌุฏุฏ</option>
</select>

<input type="text" id="marketerName" placeholder="ูุงู ุจุงุฒุงุฑุงุจ" readonly />

...

<script>
  // ...

  function updateMarketerName() {
    const code = document.getElementById("code").value.trim();
    const type = document.getElementById("type").value;
    const nameInput = document.getElementById("marketerName");

    if (!code) {
      nameInput.value = "";
      clearStatus();
      return;
    }

    if (!marketerData.hasOwnProperty(code)) {
      nameInput.value = "ฺฉุฏ ุจุงุฒุงุฑุงุจ ูุนุชุจุฑ ูุณุช!";
      setStatus("โ ฺฉุฏ ุจุงุฒุงุฑุงุจ ูุนุชุจุฑ ูุณุช.");
      return;
    }

    if (!type) {
      nameInput.value = "";
      clearStatus();
      return;
    }

    nameInput.value = (marketerData[code].promoterName || "").trim() || "ูุงู ููุฌูุฏ ูุณุช";
    clearStatus();
  }

  function sendForm(position) {
    const code = document.getElementById("code").value.trim();
    const type = document.getElementById("type").value;
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;

    const spotLat = marketerData[code].lat;
    const spotLon = marketerData[code].lon;
    const dist = distanceInMeters(lat, lon, spotLat, spotLon);

    if (dist > 500) {
      setStatus(`โ ุดูุง ุจุด ุงุฒ ตฐฐ ูุชุฑ ุงุฒ ูุญู ุงุณูพุงุช ูุงุตูู ุฏุงุฑุฏ! (${Math.round(dist)} ูุชุฑ)`);
      return;
    }

    const form = new FormData();
    form.append("entry.1655541032", type);
    form.append("entry.1228562108", code);
    form.append("entry.2093256559", `${lat.toFixed(6)}, ${lon.toFixed(6)}`);

    fetch("https://docs.google.com/forms/d/e/1FAIpQLSdY70VGHakFIzh9zjWbfZ2T-tBqUg3xtNEZwG4drNpjnbwrjg/formResponse", {
      method: "POST",
      mode: "no-cors",
      body: form,
    }).then(() => {
      const name = (marketerData[code].promoterName || "").trim();
      setStatus(`โ ุญุถูุฑ ${name || "ุจุงุฒุงุฑุงุจ"} ุซุจุช ุดุฏ.`, true);
    }).catch(() => {
      setStatus("โ ุฎุทุง ุฏุฑ ุงุฑุณุงู ูุฑู!");
    });
  }

  function showDates() {
    const nowTehranStr = new Date().toLocaleString('en-US', { timeZone: 'Asia/Tehran' });
    const nowTehran = new Date(nowTehranStr);

    const days = ['ุดูุจู', 'ฺฉุดูุจู', 'ุฏูุดูุจู', 'ุณูโุดูุจู', 'ฺูุงุฑุดูุจู', 'ูพูุฌุดูุจู', 'ุฌูุนู'];
    const months = ['ูุฑูุฑุฏู', 'ุงุฑุฏุจูุดุช', 'ุฎุฑุฏุงุฏ', 'ุชุฑ', 'ูุฑุฏุงุฏ', 'ุดูุฑูุฑ', 'ููุฑ', 'ุขุจุงู', 'ุขุฐุฑ', 'ุฏ', 'ุจููู', 'ุงุณููุฏ'];

    function toJalali(gy, gm, gd) {
      var g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
      var gy2 = (gm > 2) ? (gy + 1) : gy;
      var days = 355666 + (365 * gy) + parseInt((gy2 + 3) / 4) - parseInt((gy2 + 99) / 100) + parseInt((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
      var jy = -1595 + (33 * parseInt(days / 12053));
      days %= 12053;
      jy += 4 * parseInt(days / 1461);
      days %= 1461;
      if (days > 365) {
        jy += parseInt((days - 1) / 365);
        days = (days - 1) % 365;
      }
      var jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
      var jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
      return [jy, jm, jd];
    }

    function getPersianWeekday(date) {
      return (date.getDay() + 1) % 7;
    }

    const persianDayIndex = getPersianWeekday(nowTehran);
    const persianWeekday = days[persianDayIndex];
    const [jy, jm, jd] = toJalali(nowTehran.getFullYear(), nowTehran.getMonth() + 1, nowTehran.getDate());
    const stickers = ['๐', '๐', '๐', '๐', '๐', 'โญ', '๐'];

    const persianDateText = `${persianWeekday} ${jd} ${months[jm - 1]} ${jy} ${stickers[persianDayIndex]}`;
    const gregorianDateText = nowTehran.toLocaleDateString('en-US');

    document.getElementById("dates").innerHTML = `${persianDateText} <br> ${gregorianDateText}`;
  }
</script>
