<!DOCTYPE html>
<html>
<head>
    <title>ثبت حضور بازاریاب</title>
    <meta charset="utf-8">
</head>
<body>
    <button id="getLocation">ثبت موقعیت فعلی</button>
    <div id="result"></div>

    <script>
        document.getElementById('getLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(submitAttendance, showError);
            } else {
                alert("مرورگر شما از سرویس موقعیت‌یابی پشتیبانی نمی‌کند");
            }
        });

        function showError(error) {
            alert(`خطا در دریافت موقعیت: ${error.message}`);
        }

        async function submitAttendance(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            
            // 1. دریافت لیست اسپات‌ها از گوگل شیت
            const spots = await getSpotsData();
            
            // 2. پیدا کردن نزدیک‌ترین اسپات
            const nearestSpot = findNearestSpot(userLat, userLon, spots);
            
            // 3. ارسال داده به فرم گوگل
            await submitToGoogleForm(nearestSpot);
            
            document.getElementById('result').innerHTML = `
                <p>ثبت حضور با موفقیت انجام شد!</p>
                <p>اسپات: ${nearestSpot.Spot}</p>
                <p>بازاریاب: ${nearestSpot.Name}</p>
                <p>زمان: ${new Date().toLocaleString('fa-IR')}</p>
            `;
        }

        async function getSpotsData() {
            // این آدرس باید با آدرس واقعی API شما جایگزین شود
            const response = await fetch('https://script.google.com/macros/s/AKfycbytqr3GGxdY4pEs3O_Nl61qD-jmq9FwVdbE-UXpN8LTkVubXIy_9I1BiTsvhGxSs5th/exec');
            return await response.json();
        }

        function findNearestSpot(userLat, userLon, spots) {
            let nearest = null;
            let minDistance = Infinity;
            
            spots.forEach(spot => {
                const distance = calculateDistance(
                    userLat, 
                    userLon,
                    parseFloat(spot.Lat),
                    parseFloat(spot.Lon)
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = spot;
                }
            });
            
            return nearest;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            // فرمول محاسبه فاصله هاوِرساین
            const R = 6371; // شعاع زمین
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; // فاصله بر حسب کیلومتر
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        async function submitToGoogleForm(spot) {
            const formData = new FormData();
            
            // این مقادیر باید با ID فیلدهای فرم شما تطبیق داده شود
            formData.append('entry.123456789', spot.Name); // نام بازاریاب
            formData.append('entry.987654321', spot.Spot); // نام اسپات
            formData.append('entry.555555555', new Date().toISOString()); // زمان
            
            await fetch(
                'https://docs.google.com/forms/d/e/1FAIpQLSdY70VGHakFIzh9zjWbfZ2T-tBqUg3xtNEZwG4drNpjnbwrjg/formResponse',
                {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                }
            );
        }
    </script>
</body>
</html>
