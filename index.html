<!-- کد کامل اصلاح‌شده -->
<input type="text" id="code" placeholder="کد بازاریابی را وارد کنید" autocomplete="off" />

<select id="type" aria-label="نوع ثبت حضور">
  <option value="" disabled selected>نوع ثبت حضور را انتخاب کنید</option>
  <option value="شروع شیفت">شروع شیفت</option>
  <option value="پایان شیفت">پایان شیفت</option>
  <option value="ثبت نام جدید">ثبت نام جدید</option>
</select>

<input type="text" id="marketerName" placeholder="نام بازاریاب" readonly />

...

<script>
  // ...

  function updateMarketerName() {
    const code = document.getElementById("code").value.trim();
    const type = document.getElementById("type").value;
    const nameInput = document.getElementById("marketerName");

    if (!code) {
      nameInput.value = "";
      clearStatus();
      return;
    }

    if (!marketerData.hasOwnProperty(code)) {
      nameInput.value = "کد بازاریاب معتبر نیست!";
      setStatus("❌ کد بازاریاب معتبر نیست.");
      return;
    }

    if (!type) {
      nameInput.value = "";
      clearStatus();
      return;
    }

    nameInput.value = (marketerData[code].promoterName || "").trim() || "نام موجود نیست";
    clearStatus();
  }

  function sendForm(position) {
    const code = document.getElementById("code").value.trim();
    const type = document.getElementById("type").value;
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;

    const spotLat = marketerData[code].lat;
    const spotLon = marketerData[code].lon;
    const dist = distanceInMeters(lat, lon, spotLat, spotLon);

    if (dist > 500) {
      setStatus(`❌ شما بیش از ۵۰۰ متر از محل اسپات فاصله دارید! (${Math.round(dist)} متر)`);
      return;
    }

    const form = new FormData();
    form.append("entry.1655541032", type);
    form.append("entry.1228562108", code);
    form.append("entry.2093256559", `${lat.toFixed(6)}, ${lon.toFixed(6)}`);

    fetch("https://docs.google.com/forms/d/e/1FAIpQLSdY70VGHakFIzh9zjWbfZ2T-tBqUg3xtNEZwG4drNpjnbwrjg/formResponse", {
      method: "POST",
      mode: "no-cors",
      body: form,
    }).then(() => {
      const name = (marketerData[code].promoterName || "").trim();
      setStatus(`✅ حضور ${name || "بازاریاب"} ثبت شد.`, true);
    }).catch(() => {
      setStatus("❌ خطا در ارسال فرم!");
    });
  }

  function showDates() {
    const nowTehranStr = new Date().toLocaleString('en-US', { timeZone: 'Asia/Tehran' });
    const nowTehran = new Date(nowTehranStr);

    const days = ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه'];
    const months = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];

    function toJalali(gy, gm, gd) {
      var g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
      var gy2 = (gm > 2) ? (gy + 1) : gy;
      var days = 355666 + (365 * gy) + parseInt((gy2 + 3) / 4) - parseInt((gy2 + 99) / 100) + parseInt((gy2 + 399) / 400) + gd + g_d_m[gm - 1];
      var jy = -1595 + (33 * parseInt(days / 12053));
      days %= 12053;
      jy += 4 * parseInt(days / 1461);
      days %= 1461;
      if (days > 365) {
        jy += parseInt((days - 1) / 365);
        days = (days - 1) % 365;
      }
      var jm = (days < 186) ? 1 + parseInt(days / 31) : 7 + parseInt((days - 186) / 30);
      var jd = 1 + ((days < 186) ? (days % 31) : ((days - 186) % 30));
      return [jy, jm, jd];
    }

    function getPersianWeekday(date) {
      return (date.getDay() + 1) % 7;
    }

    const persianDayIndex = getPersianWeekday(nowTehran);
    const persianWeekday = days[persianDayIndex];
    const [jy, jm, jd] = toJalali(nowTehran.getFullYear(), nowTehran.getMonth() + 1, nowTehran.getDate());
    const stickers = ['🌞', '🌜', '🌛', '🌚', '🌝', '⭐', '🌟'];

    const persianDateText = `${persianWeekday} ${jd} ${months[jm - 1]} ${jy} ${stickers[persianDayIndex]}`;
    const gregorianDateText = nowTehran.toLocaleDateString('en-US');

    document.getElementById("dates").innerHTML = `${persianDateText} <br> ${gregorianDateText}`;
  }
</script>
