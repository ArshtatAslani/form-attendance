<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <!-- بخش head بدون تغییر -->
</head>
<body>
  <!-- محتوای بدنه بدون تغییر -->
  
<script>
  // متغیرهای global
  let marketerData = {};
  let currentStream = null;
  let capturedPhoto = null;
  const apiURL = "https://script.google.com/macros/s/AKfycbystRT9QASXITDMlIYQB-068PIvH310F4wVkroqq6E16aYcwXPd7pKjp-svxjffgqxz/exec";

  // تابع بهبود یافته برای دریافت داده‌های بازاریاب‌ها
  function fetchMarketerData() {
    fetch(apiURL)
      .then(res => {
        if (!res.ok) throw new Error("خطا در دریافت داده‌ها");
        return res.json();
      })
      .then(data => {
        marketerData = data;
        console.log("داده‌های دریافت شده:", marketerData);
        document.getElementById('captureBtn').style.display = "block";
      })
      .catch(err => {
        console.error("خطا در دریافت داده‌ها:", err);
        setStatus("❌ خطا در دریافت اطلاعات بازاریاب‌ها از سرور");
      });
  }

  // تابع بهبود یافته برای نمایش اطلاعات بازاریاب
  function updateMarketerInfo() {
    const code = document.getElementById("code").value.trim();
    const nameInput = document.getElementById("marketerName");
    const spotInput = document.getElementById("spotName");
    
    nameInput.value = "";
    spotInput.value = "";
    
    if (!code) {
      clearStatus();
      return;
    }

    if (!marketerData || !marketerData[code]) {
      nameInput.value = "کد بازاریاب یافت نشد";
      spotInput.value = "اسپات یافت نشد";
      setStatus("⚠️ کد بازاریاب وارد شده در سیستم موجود نیست");
      return;
    }

    const marketer = marketerData[code];
    nameInput.value = marketer.marketerName || "نام ثبت نشده";
    spotInput.value = marketer.spotName || "اسپات ثبت نشده";
    clearStatus();
  }

  // تابع بهبود یافته برای ارسال اطلاعات
  async function submitRegistration() {
    const code = document.getElementById("code").value.trim();
    const type = document.getElementById("type").value;
    
    // اعتبارسنجی پیشرفته
    const validations = [
      { condition: !code, message: "❌ لطفاً کد بازاریاب را وارد کنید" },
      { condition: !type, message: "❌ لطفاً نوع ثبت حضور را انتخاب کنید" },
      { condition: !marketerData[code], message: "❌ کد بازاریاب معتبر نیست" },
      { condition: !capturedPhoto, message: "❌ لطفاً ابتدا عکس بگیرید" }
    ];
    
    for (const val of validations) {
      if (val.condition) {
        setStatus(val.message);
        return;
      }
    }

    setStatus("در حال ارسال اطلاعات... لطفاً صبر کنید");

    try {
      const nowTehran = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Tehran' }));
      const formattedDate = nowTehran.toISOString().slice(0,10).replace(/-/g, '');
      const formattedTime = nowTehran.toTimeString().slice(0,8).replace(/:/g, '');
      
      const [jy, jm, jd] = toJalali(nowTehran.getFullYear(), nowTehran.getMonth() + 1, nowTehran.getDate());
      
      const formData = {
        marketerCode: code,
        marketerName: marketerData[code].marketerName || "",
        spotName: marketerData[code].spotName || "",
        type: type,
        datetime: nowTehran.toISOString(),
        persianDate: `${jy}/${jm}/${jd}`,
        photo: capturedPhoto,
        fileName: `${code}-${formattedDate}-${formattedTime}.jpg`,
        deviceInfo: navigator.userAgent
      };

      // اضافه کردن timeout برای fetch
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);
      
      const response = await fetch(apiURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) throw new Error("پاسخ نامعتبر از سرور");
      
      const result = await response.json();
      
      if (result.status === "success") {
        setStatus("✅ ثبت حضور با موفقیت انجام شد. شماره پیگیری: " + (result.referenceId || ''), true);
        resetForm();
      } else {
        throw new Error(result.message || "خطای نامشخص از سرور");
      }
    } catch (error) {
      console.error("خطا در ارسال:", error);
      setStatus(`❌ خطا در ارسال اطلاعات: ${error.message || "خطای اتصال به سرور"}`);
    }
  }

  // بقیه توابع بدون تغییر
  // ...
</script>
</body>
</html>
