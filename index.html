<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ثبت حضور</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    button, select { padding: 10px; margin: 10px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>ثبت حضور بازاریاب</h2>

  <select id="marketerSelect" onchange="updateSpots()">
    <option value="">انتخاب بازاریاب</option>
  </select>

  <select id="spotSelect">
    <option value="">انتخاب اسپات</option>
  </select>

  <br>

  <button onclick="submitRegistration('شروع')">شروع فعالیت</button>
  <button onclick="submitRegistration('پایان')">پایان فعالیت</button>

  <p id="message"></p>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbytqr3GGxdY4pEs3O_Nl61qD-jmq9FwVdbE-UXpN8LTkVubXIy_9I1BiTsvhGxSs5th/exec";
    let marketers = [];

    async function fetchMarketers() {
      try {
        const res = await fetch(WEB_APP_URL + "?action=getMarketers");
        const data = await res.json();

        if (!data.marketers) {
          document.getElementById("message").innerText = "خطا در دریافت اطلاعات";
          return;
        }

        marketers = data.marketers;

        const marketerSelect = document.getElementById("marketerSelect");
        const uniqueNames = [...new Set(marketers.map(m => m.name))];
        uniqueNames.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          marketerSelect.appendChild(opt);
        });

        updateSpots();
      } catch (err) {
        document.getElementById("message").innerText = "خطا در بارگذاری اطلاعات: " + err.message;
      }
    }

    function updateSpots() {
      const selectedName = document.getElementById("marketerSelect").value;
      const spotSelect = document.getElementById("spotSelect");
      spotSelect.innerHTML = '<option value="">انتخاب اسپات</option>';

      const filtered = marketers.filter(m => m.name === selectedName);
      filtered.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.spot;
        opt.textContent = m.spot;
        spotSelect.appendChild(opt);
      });
    }

    async function submitRegistration(status) {
      const name = document.getElementById("marketerSelect").value;
      const spot = document.getElementById("spotSelect").value;
      const messageEl = document.getElementById("message");

      if (!name || !spot) {
        messageEl.innerText = "لطفاً نام بازاریاب و اسپات را انتخاب کنید";
        return;
      }

      const match = marketers.find(m => m.name === name && m.spot === spot);
      if (!match) {
        messageEl.innerText = "اطلاعات مطابقت ندارد";
        return;
      }

      const payload = {
        name: name,
        spot: spot,
        lat: match.lat,
        lon: match.lon,
        status: status
      };

      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        });

        const result = await res.json();
        if (result.success) {
          messageEl.innerText = `ثبت ${status} با موفقیت انجام شد ✅`;
        } else {
          messageEl.innerText = "خطا در ثبت اطلاعات: " + result.error;
        }
      } catch (err) {
        messageEl.innerText = "خطای ارسال: " + err.message;
      }
    }

    fetchMarketers();
  </script>
</body>
</html>
