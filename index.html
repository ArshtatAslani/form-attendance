<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø«Ø¨Øª Ø­Ø¶ÙˆØ± Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨</title>
  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      background-color: #f8f9fa;
      text-align: center;
      padding: 40px;
      color: #333;
    }
    h2 {
      margin-bottom: 30px;
      color: #2c3e50;
    }
    input, select, button {
      width: 90%;
      max-width: 300px;
      padding: 12px;
      margin: 10px auto;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }
    button {
      background-color: #2ecc71;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #27ae60;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <h2>ğŸ“ Ø«Ø¨Øª Ø­Ø¶ÙˆØ± Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨</h2>

  <input type="text" id="code" placeholder="Ú©Ø¯ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" />
  <select id="type">
    <option value="Ø´Ø±ÙˆØ¹ Ø´ÛŒÙØª">Ø´Ø±ÙˆØ¹ Ø´ÛŒÙØª</option>
    <option value="Ù¾Ø§ÛŒØ§Ù† Ø´ÛŒÙØª">Ù¾Ø§ÛŒØ§Ù† Ø´ÛŒÙØª</option>
  </select>
  <button onclick="getLocation()">Ø«Ø¨Øª Ø­Ø¶ÙˆØ±</button>

  <p id="status"></p>

  <script>
    let locations = {}; // Ù…Ø­Ù„ Ø°Ø®ÛŒØ±Ù‡ Ù…Ø®ØªØµØ§Øª Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨â€ŒÙ‡Ø§

    // Ø¢Ø¯Ø±Ø³ ÙˆØ¨ Ø§Ù¾ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø´Ù…Ø§ (Ù„ÛŒÙ†Ú© Deploy Ø´Ø¯Ù‡)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbystRT9QASXITDMlIYQB-068PIvH310F4wVkroqq6E16aYcwXPd7pKjp-svxjffgqxz/exec"; // â† Ø§ÛŒÙ† Ø±Ùˆ Ø¨Ø§ Ù„ÛŒÙ†Ú© Ø®ÙˆØ¯Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø®ØªØµØ§Øª Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨â€ŒÙ‡Ø§ Ø§Ø² Google Sheets
    fetch(SCRIPT_URL)
      .then(res => res.json())
      .then(data => {
        locations = data;
        console.log("Ù…Ø®ØªØµØ§Øª Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯:", locations);
      })
      .catch(err => {
        console.error("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø®ØªØµØ§Øª:", err);
        document.getElementById("status").textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨â€ŒÙ‡Ø§";
      });

    // ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ø¯Ùˆ Ù†Ù‚Ø·Ù‡ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø¨Ù‡ Ù…ØªØ±
    function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Ø´Ø¹Ø§Ø¹ Ø²Ù…ÛŒÙ† Ø¨Ù‡ Ù…ØªØ±
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function getLocation() {
      const status = document.getElementById("status");
      status.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ...";
      if (!navigator.geolocation) {
        status.textContent = "Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² GPS Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
        return;
      }

      navigator.geolocation.getCurrentPosition(sendForm, (err) => {
        status.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª: " + err.message;
      }, { timeout: 10000 });
    }

    function sendForm(position) {
      const code = document.getElementById("code").value.trim();
      const type = document.getElementById("type").value;
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      const status = document.getElementById("status");

      if (!code) {
        status.textContent = "â— Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";
        return;
      }

      if (!locations[code]) {
        status.textContent = "âŒ Ú©Ø¯ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯.";
        return;
      }

      const loc = locations[code];
      const distance = getDistanceFromLatLonInMeters(lat, lon, loc.lat, loc.lon);

      if (distance > 500) {
        status.textContent = `âŒ Ø´Ù…Ø§ Ø¨ÛŒØ´ Ø§Ø² ÛµÛ°Û° Ù…ØªØ± Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØª ØªØ¹Ø±ÛŒÙâ€ŒØ´Ø¯Ù‡ ÙØ§ØµÙ„Ù‡ Ø¯Ø§Ø±ÛŒØ¯ (ÙØ§ØµÙ„Ù‡: ${distance.toFixed(0)} Ù…ØªØ±).`;
        return;
      }

      // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ ÙØ±Ù…
      const form = new FormData();
      form.append("entry.1655541032", type);           // Ù†ÙˆØ¹ Ø´ÛŒÙØª
      form.append("entry.1228562108", code);           // Ú©Ø¯ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨
      form.append("entry.2093256559", `${lat.toFixed(6)}, ${lon.toFixed(6)}`); // Ù„ÙˆÚ©ÛŒØ´Ù†

      fetch("https://docs.google.com/forms/d/e/1FAIpQLSdY70VGHakFIzh9zjWbfZ2T-tBqUg3xtNEZwG4drNpjnbwrjg/formResponse", {
        method: "POST",
        mode: "no-cors",
        body: form,
      }).then(() => {
        status.textContent = "âœ… Ø­Ø¶ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.";
      }).catch((err) => {
        status.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø­Ø¶ÙˆØ±.";
        console.error(err);
      });
    }
  </script>
</body>
</html>
