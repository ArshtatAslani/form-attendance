<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ثبت حضور با عکس و موقعیت</title>
  <style>
    body {
      font-family: Tahoma, sans-serif;
      direction: rtl;
      padding: 10px;
      background: #f0f0f0;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, button {
      padding: 8px;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
      margin-top: 5px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
    canvas {
      display: none;
    }
  </style>
</head>
<body>

  <h2>ثبت حضور بازاریاب</h2>

  <div>تاریخ شمسی: <span id="shamsiDate"></span></div>
  <div>تاریخ میلادی: <span id="gregorianDate"></span></div>

  <label for="code">کد بازاریابی:</label>
  <input type="text" id="code" autocomplete="off" />

  <label for="marketerName">نام بازاریاب:</label>
  <input type="text" id="marketerName" readonly />

  <label for="type">نوع ثبت حضور:</label>
  <select id="type">
    <option value="">انتخاب کنید</option>
    <option value="ورود">ورود</option>
    <option value="خروج">خروج</option>
  </select>

  <video id="video" autoplay playsinline style="width: 300px; margin-top: 15px; border: 1px solid #ccc;"></video>
  <canvas id="canvas" width="300" height="225"></canvas>

  <button id="registerBtn" style="margin-top: 20px;">ثبت حضور</button>

  <div id="status"></div>

  <script src="https://cdn.jsdelivr.net/npm/@persian-date/persian-date/dist/persian-date.min.js"></script>
  <script>
    // نمایش تاریخ شمسی و میلادی
    const pd = new persianDate();
    document.getElementById('shamsiDate').innerText = pd.format('YYYY/MM/DD');
    document.getElementById('gregorianDate').innerText = new Date().toISOString().split('T')[0];

    // نمونه داده بازاریاب‌ها
    const marketerData = {
      "1001": { name: "علی رضایی", active: true },
      "1002": { name: "سارا احمدی", active: true },
      "1003": { name: "مهدی حسینی", active: false }
    };

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // باز کردن دوربین پشت (environment)
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }
    }).then(stream => {
      video.srcObject = stream;
    }).catch(err => {
      // اگر دوربین پشت در دسترس نبود، دوربین جلو باز شود
      navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" }
      }).then(stream => {
        video.srcObject = stream;
      }).catch(error => {
        alert("دوربین فعال نیست: " + error.message);
      });
    });

    // نمایش نام بازاریاب با توجه به کد
    document.getElementById("code").addEventListener("input", () => {
      const code = document.getElementById("code").value.trim();
      const nameInput = document.getElementById("marketerName");
      if (!marketerData[code]) {
        nameInput.value = "";
        setStatus("⚠️ کد بازاریابی یافت نشد");
        return;
      }
      const marketer = marketerData[code];
      if (!marketer.active) {
        setStatus("⚠️ این بازاریاب فعال نیست");
        nameInput.value = "";
        return;
      }
      nameInput.value = marketer.name;
      clearStatus();
    });

    function setStatus(msg, success = false) {
      const s = document.getElementById("status");
      s.innerText = msg;
      s.style.color = success ? "green" : "red";
    }
    function clearStatus() {
      setStatus("");
    }

    // تابع گرفتن عکس و بازگشت blob
    function capturePhoto() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return new Promise((resolve) => {
        canvas.toBlob(blob => {
          resolve(blob);
        }, 'image/jpeg');
      });
    }

    // ثبت حضور و گرفتن عکس و آپلود
    document.getElementById("registerBtn").onclick = async () => {
      const code = document.getElementById("code").value.trim();
      const type = document.getElementById("type").value;
      const name = document.getElementById("marketerName").value.trim();

      if (!code || !type) {
        setStatus("لطفاً کد و نوع ثبت حضور را وارد کنید");
        return;
      }

      setStatus("در حال ثبت حضور و گرفتن عکس...");

      // گرفتن موقعیت مکانی
      if (!navigator.geolocation) {
        setStatus("موقعیت مکانی در این مرورگر پشتیبانی نمی‌شود");
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        // گرفتن عکس
        const photoBlob = await capturePhoto();

        // آپلود عکس
        const formData = new FormData();
        formData.append('file', photoBlob, 'photo.jpg');

        try {
          // جایگزین با آدرس آپلود عکس واقعی شما
          const uploadResponse = await fetch('YOUR_PHOTO_UPLOAD_URL', {
            method: 'POST',
            body: formData
          });
          if (!uploadResponse.ok) throw new Error('خطا در آپلود عکس');

          // ارسال اطلاعات ثبت حضور به API
          const dataToSend = { code, type, name, lat, lon };
          const registerResponse = await fetch('YOUR_REGISTER_API_URL', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
          });
          const registerResult = await registerResponse.json();

          if (registerResult.success) {
            setStatus("✅ ثبت حضور و آپلود عکس موفق بود", true);
          } else {
            setStatus("❌ خطا در ثبت حضور");
          }
        } catch (error) {
          setStatus("❌ خطا: " + error.message);
        }
      }, (err) => {
        setStatus("❌ خطا در دریافت موقعیت مکانی: " + err.message);
      });
    };
  </script>

</body>
</html>
